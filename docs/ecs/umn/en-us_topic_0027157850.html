<a name="EN-US_TOPIC_0027157850"></a><a name="EN-US_TOPIC_0027157850"></a>

<h1 class="topictitle1">Enabling Internet Connectivity for an <span id="text123765419131">ECS</span> Without an EIP</h1>
<div id="body1457574115625"><div class="section" id="EN-US_TOPIC_0027157850__section6427533194453"><h4 class="sectiontitle">Scenarios</h4><p id="EN-US_TOPIC_0027157850__p6524555495935">To ensure platform security and conserve EIPs, EIPs are assigned only to specified <span id="EN-US_TOPIC_0027157850__text1545011314395">ECS</span>s. <span id="EN-US_TOPIC_0027157850__text11886342077">ECS</span>s without EIPs cannot access the Internet directly. If these ECSs need to access the Internet (for example, to perform a software upgrade or install a patch), you can select an ECS with an EIP bound to function as a proxy ECS, providing an access channel for these ECSs.</p>
<div class="note" id="EN-US_TOPIC_0027157850__note133331220133410"><img src="public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p id="EN-US_TOPIC_0027157850__p19333520143410">NAT Gateway is recommended, which provides both the SNAT and DNAT functions for your <span id="EN-US_TOPIC_0027157850__text19249736143915">ECS</span>s in a VPC and allows the <span id="EN-US_TOPIC_0027157850__text11698155411811">ECS</span>s to access or provide services accessible from the Internet. </p>
</div></div>
</div>
<div class="section" id="EN-US_TOPIC_0027157850__section2608915610029"><h4 class="sectiontitle">Prerequisites</h4><ul id="EN-US_TOPIC_0027157850__ul57147806103027"><li id="EN-US_TOPIC_0027157850__li5394806103027">A proxy <span id="EN-US_TOPIC_0027157850__text15137193753916">ECS</span> with an EIP bound is available.</li><li id="EN-US_TOPIC_0027157850__li43600437114252">The IP address of the proxy <span id="EN-US_TOPIC_0027157850__text1698539203918">ECS</span> is in the same network and same security group as the <span id="EN-US_TOPIC_0027157850__text3883204613918">ECS</span>s that need to access the Internet.</li></ul>
</div>
<div class="section" id="EN-US_TOPIC_0027157850__section6907807103042"><h4 class="sectiontitle">Linux Proxy <span id="EN-US_TOPIC_0027157850__text11280191042018">ECS</span></h4><p id="EN-US_TOPIC_0027157850__p96322674819">In this example, the proxy <span id="EN-US_TOPIC_0027157850__text120563515207">ECS</span> runs CentOS 6.5.</p>
<ol id="EN-US_TOPIC_0027157850__ol33320884113959"><li id="EN-US_TOPIC_0027157850__li3490190117228">Log in to the management console.</li><li id="EN-US_TOPIC_0027157850__li464234814566">Click <span><img id="EN-US_TOPIC_0027157850__en-us_topic_0014250631_image1862675853202121" src="en-us_image_0210779229.png"></span> in the upper left corner and select your region and project.</li><li id="EN-US_TOPIC_0027157850__li46924084113959">Under <strong id="EN-US_TOPIC_0027157850__b148928941417"><span id="EN-US_TOPIC_0027157850__text68911931412">Computing</span></strong>, click <strong id="EN-US_TOPIC_0027157850__b58921495146">Elastic Cloud Server</strong>.</li><li id="EN-US_TOPIC_0027157850__li42754441113959">In the search box above the upper right corner of the <span id="EN-US_TOPIC_0027157850__text6178154220399">ECS</span> list, enter the proxy <span id="EN-US_TOPIC_0027157850__text6468125715118">ECS</span> name for search.</li><li id="EN-US_TOPIC_0027157850__li49245655113959">Click the name of the proxy <span id="EN-US_TOPIC_0027157850__text10882134212391">ECS</span>. The page providing details about the <span id="EN-US_TOPIC_0027157850__text1799143012106">ECS</span> is displayed.</li><li id="EN-US_TOPIC_0027157850__li38671581113959">Click the <strong id="EN-US_TOPIC_0027157850__b84235270618429">Network Interfaces</strong> tab and then <span><img id="EN-US_TOPIC_0027157850__image16740174871" src="en-us_image_0128851717.png"></span>. Then, disable <strong id="EN-US_TOPIC_0027157850__b84235270618529">Source/Destination Check</strong>.<p id="EN-US_TOPIC_0027157850__p1846151153411">By default, the source/destination check function is enabled. When this function is enabled, the system checks whether source IP addresses contained in the packets sent by <span id="EN-US_TOPIC_0027157850__text159541444113919">ECS</span>s are correct. If the IP addresses are incorrect, the system does not allow the <span id="EN-US_TOPIC_0027157850__text16431453151110">ECS</span>s to send the packets. This mechanism prevents packet spoofing, thereby improving system security. However, this mechanism prevents the packet sender from receiving returned packets. Therefore, disable the source/destination check.</p>
</li><li id="EN-US_TOPIC_0027157850__li5860308113959">Log in to the proxy <span id="EN-US_TOPIC_0027157850__text7842746163912">ECS</span>.<p id="EN-US_TOPIC_0027157850__p45390388113959">For more details, see <a href="en-us_topic_0013771089.html">Login Overview</a>.</p>
</li><li id="EN-US_TOPIC_0027157850__li32041953113959">Run the following command to check whether the proxy <span id="EN-US_TOPIC_0027157850__text525035053916">ECS</span> can access the Internet:<p id="EN-US_TOPIC_0027157850__p4922924113959"><strong id="EN-US_TOPIC_0027157850__b52742774113959">ping www.google.com</strong></p>
<p id="EN-US_TOPIC_0027157850__p44306317113959">The proxy <span id="EN-US_TOPIC_0027157850__text12634115123917">ECS</span> can access the Internet if information similar to the following is displayed:</p>
<pre class="screen" id="EN-US_TOPIC_0027157850__screen63212540113959">64 bytes from 220.181.111.148: icmp_seq=1 ttl=51 time=9.34 ms
64 bytes from 220.181.111.148: icmp_seq=2 ttl=51 time=9.11 ms
64 bytes from 220.181.111.148: icmp_seq=3 ttl=51 time=8.99 ms</pre>
</li><li id="EN-US_TOPIC_0027157850__li1543981113959">Run the following command to check whether IP forwarding is enabled on the proxy <span id="EN-US_TOPIC_0027157850__text168503538394">ECS</span>:<p id="EN-US_TOPIC_0027157850__p45261401113959"><strong id="EN-US_TOPIC_0027157850__b19942125113959">cat /proc/sys/net/ipv4/ip_forward</strong></p>
<ul id="EN-US_TOPIC_0027157850__ul29997715113959"><li id="EN-US_TOPIC_0027157850__li42294878113959">If <strong id="EN-US_TOPIC_0027157850__b842352706182537">0</strong> (disabled) is displayed, go to <a href="#EN-US_TOPIC_0027157850__li51820417113959">10</a>.</li><li id="EN-US_TOPIC_0027157850__li3333079113959">If <strong id="EN-US_TOPIC_0027157850__b842352706182611">1</strong> (enabled), go to <a href="#EN-US_TOPIC_0027157850__li49419571113959">16</a>.</li></ul>
</li><li id="EN-US_TOPIC_0027157850__li51820417113959"><a name="EN-US_TOPIC_0027157850__li51820417113959"></a><a name="li51820417113959"></a>Run the following command to open the IP forwarding configuration file in the vi editor:<p id="EN-US_TOPIC_0027157850__p57953607113959"><a name="EN-US_TOPIC_0027157850__li51820417113959"></a><a name="li51820417113959"></a><strong id="EN-US_TOPIC_0027157850__b13895830113959">vi /etc/sysctl.conf</strong></p>
</li><li id="EN-US_TOPIC_0027157850__li63730573113959">Press <strong id="EN-US_TOPIC_0027157850__b4743173411917">i</strong> to enter editing mode.</li><li id="EN-US_TOPIC_0027157850__li61902825113959">Set the <strong id="EN-US_TOPIC_0027157850__b84235270618748">net.ipv4.ip_forward</strong> value to <strong id="EN-US_TOPIC_0027157850__b84235270618753">1</strong>.<p id="EN-US_TOPIC_0027157850__p36704253113959">Set the <strong id="EN-US_TOPIC_0027157850__b84235270618280">net.ipv4.ip_forward</strong> value to <strong id="EN-US_TOPIC_0027157850__b84235270618288">1</strong>.</p>
<div class="note" id="EN-US_TOPIC_0027157850__note1343611566227"><img src="public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p id="EN-US_TOPIC_0027157850__p64362056162212">If the <strong id="EN-US_TOPIC_0027157850__b84235270615710">sysctl.conf</strong> file does not contain the <strong id="EN-US_TOPIC_0027157850__b84235270615720">net.ipv4.ip_forward</strong> parameter, run the following command to add it:</p>
<p id="EN-US_TOPIC_0027157850__p107321635152314"><strong id="EN-US_TOPIC_0027157850__b1918516579232">echo net.ipv4.ip_forward=1 &gt;&gt; /etc/sysctl.conf</strong></p>
</div></div>
</li><li id="EN-US_TOPIC_0027157850__li30002886113959">Press <strong id="EN-US_TOPIC_0027157850__b147468341496">Esc</strong>, type <strong id="EN-US_TOPIC_0027157850__en-us_topic_0023092408_b123758096717552">:wq</strong>, and press <strong id="EN-US_TOPIC_0027157850__b1874653412912">Enter</strong>.<p id="EN-US_TOPIC_0027157850__p48072896113959">The system saves the configurations and exits the vi editor.</p>
</li><li id="EN-US_TOPIC_0027157850__li61723653113959">Run the following command to make the modification take effect:<p id="EN-US_TOPIC_0027157850__p14314724113959"><a name="EN-US_TOPIC_0027157850__li61723653113959"></a><a name="li61723653113959"></a><strong id="EN-US_TOPIC_0027157850__b1590524113959">sysctl -p /etc/sysctl.conf</strong></p>
</li><li id="EN-US_TOPIC_0027157850__li33604568113959">Run the following commands to configure default <strong id="EN-US_TOPIC_0027157850__b15498822203118">iptables</strong> rules:<p id="EN-US_TOPIC_0027157850__p1823117619111"><strong id="EN-US_TOPIC_0027157850__b127896214110">iptables -P INPUT ACCEPT</strong></p>
<p id="EN-US_TOPIC_0027157850__p6610987119"><strong id="EN-US_TOPIC_0027157850__b167131011419">iptables -P OUTPUT ACCEPT</strong></p>
<p id="EN-US_TOPIC_0027157850__p0570936112"><strong id="EN-US_TOPIC_0027157850__b13728111413">iptables -P FORWARD ACCEPT</strong></p>
<div class="caution" id="EN-US_TOPIC_0027157850__note126030541312"><span class="cautiontitle"><img src="public_sys-resources/caution_3.0-en-us.png"> </span><div class="cautionbody"><p id="EN-US_TOPIC_0027157850__p156036541815">Running <strong id="EN-US_TOPIC_0027157850__b134866201029">iptables -P INPUT ACCEPT</strong> will set default INPUT policy to ACCEPT, which poses security risks. You are advised to set security group rules to restrict inbound access.</p>
</div></div>
</li><li id="EN-US_TOPIC_0027157850__li49419571113959"><a name="EN-US_TOPIC_0027157850__li49419571113959"></a><a name="li49419571113959"></a>Run the following command to configure source network address translation (SNAT) to enable <span id="EN-US_TOPIC_0027157850__text2053045423910">ECS</span>s in the same network segment to access the Internet through the proxy <span id="EN-US_TOPIC_0027157850__text91921352191313">ECS</span>:<p id="EN-US_TOPIC_0027157850__p54843236113959"><strong id="EN-US_TOPIC_0027157850__b15551319111713">iptables -t nat -A POSTROUTING -o eth0 -s</strong> <em id="EN-US_TOPIC_0027157850__i2995066113959">subnet/netmask-bits</em> <strong id="EN-US_TOPIC_0027157850__b16811994122">-j SNAT --to</strong> <em id="EN-US_TOPIC_0027157850__i35919854113959">nat-instance-ip</em></p>
<p id="EN-US_TOPIC_0027157850__p23827079113959">For example, if the proxy <span id="EN-US_TOPIC_0027157850__text658665612395">ECS</span> is in network 192.168.125.0, the subnet mask has 24 bits, and the private IP address is 192.168.125.4, run the following command:</p>
<p id="EN-US_TOPIC_0027157850__p27860684113959"><strong id="EN-US_TOPIC_0027157850__b1855517361179">iptables -t nat -A POSTROUTING -o eth0 -s</strong> <em id="EN-US_TOPIC_0027157850__i55853760113959">192.168.125.0/24</em> <strong id="EN-US_TOPIC_0027157850__b077717554176">-j SNAT --to 192.168.125.4</strong></p>
<div class="note" id="EN-US_TOPIC_0027157850__note534810584596"><img src="public_sys-resources/note_3.0-en-us.png"><span class="notetitle"> </span><div class="notebody"><p id="EN-US_TOPIC_0027157850__p1834865845912">To retain the preceding configuration even after the ECS is restarted, run the <strong id="EN-US_TOPIC_0027157850__b65178291107">vi /etc/rc.local</strong> command to edit the <strong id="EN-US_TOPIC_0027157850__b193651827806">rc.local</strong> file. Specifically, copy the rule described in step <a href="#EN-US_TOPIC_0027157850__li49419571113959">16</a> into <strong id="EN-US_TOPIC_0027157850__b51046198115">rc.local</strong>, press <strong id="EN-US_TOPIC_0027157850__b11309226327">Esc</strong> to exit Insert mode, and enter <strong id="EN-US_TOPIC_0027157850__b519133013213">:wq</strong> to save the settings and exit.</p>
</div></div>
</li><li id="EN-US_TOPIC_0027157850__li6277114516107">Run the following commands to save the iptables configuration and make it start up automatically upon ECS startup:<p id="EN-US_TOPIC_0027157850__p13140758161010"><a name="EN-US_TOPIC_0027157850__li6277114516107"></a><a name="li6277114516107"></a><strong id="EN-US_TOPIC_0027157850__b15331059111014">service iptables save</strong></p>
<p id="EN-US_TOPIC_0027157850__p146661755112"><strong id="EN-US_TOPIC_0027157850__b516115413411">chkconfig iptables on</strong></p>
</li><li id="EN-US_TOPIC_0027157850__li47056383113959">Run the following command to check whether SNAT has been configured:<p id="EN-US_TOPIC_0027157850__p43562301113959"><a name="EN-US_TOPIC_0027157850__li47056383113959"></a><a name="li47056383113959"></a><strong id="EN-US_TOPIC_0027157850__b42122957113959">iptables -t nat --list</strong></p>
<p id="EN-US_TOPIC_0027157850__p38885512113959">SNAT has been configured if information similar to <a href="#EN-US_TOPIC_0027157850__fig27598108113959">Figure 1</a> is displayed.</p>
<div class="fignone" id="EN-US_TOPIC_0027157850__fig27598108113959"><a name="EN-US_TOPIC_0027157850__fig27598108113959"></a><a name="fig27598108113959"></a><span class="figcap"><b>Figure 1 </b>Successful SNAT configuration</span><br><span><img id="EN-US_TOPIC_0027157850__image62718780113959" src="en-us_image_0027174005.png" title="Click to enlarge" class="imgResize"></span></div>
</li><li id="EN-US_TOPIC_0027157850__li66936514113959">Add a route.<ol type="a" id="EN-US_TOPIC_0027157850__ol52176633113959"><li id="EN-US_TOPIC_0027157850__li648610515510">Log in to the management console.</li><li id="EN-US_TOPIC_0027157850__li7951089219">Click <span><img id="EN-US_TOPIC_0027157850__en-us_topic_0014250631_image1862675853202121_1" src="en-us_image_0210779229.png"></span> in the upper left corner and select your region and project.</li><li id="EN-US_TOPIC_0027157850__li53470716113959">Under <strong id="EN-US_TOPIC_0027157850__b341888960"><span id="EN-US_TOPIC_0027157850__text159160124215">Network</span></strong>, click <strong id="EN-US_TOPIC_0027157850__b1923799494">Virtual Private Cloud</strong>.</li><li id="EN-US_TOPIC_0027157850__li11474399113959">Choose <strong id="EN-US_TOPIC_0027157850__b18105111173">Route Tables</strong> in the left navigation pane. On the displayed page, click a VPC which a route is to be added to. On the displayed page, click <strong id="EN-US_TOPIC_0027157850__b73147752173149">Add Route</strong>.</li><li id="EN-US_TOPIC_0027157850__li20710484113959">Set route information on the displayed page.<ul id="EN-US_TOPIC_0027157850__ul54496948113959"><li id="EN-US_TOPIC_0027157850__li36160729113959"><strong id="EN-US_TOPIC_0027157850__b737881915">Destination</strong>: indicates the destination network segment. The default value is <strong id="EN-US_TOPIC_0027157850__b1978815948">0.0.0.0/0</strong>.</li><li id="EN-US_TOPIC_0027157850__li43337918113959"><strong id="EN-US_TOPIC_0027157850__b267029115">Next Hop</strong>: indicates the private IP address of the SNAT <span id="EN-US_TOPIC_0027157850__text1541514241">ECS</span>.<p id="EN-US_TOPIC_0027157850__p57011107113959">You can obtain the private IP address of the <span id="EN-US_TOPIC_0027157850__text48821157123917">ECS</span> on the <strong id="EN-US_TOPIC_0027157850__b11550213161515">Elastic Cloud Server</strong> page.</p>
</li></ul>
</li></ol>
</li><li id="EN-US_TOPIC_0027157850__li8776155274817">To delete the added iptables rules, run the following command:<p id="EN-US_TOPIC_0027157850__p237194319550"><a name="EN-US_TOPIC_0027157850__li8776155274817"></a><a name="li8776155274817"></a><strong id="EN-US_TOPIC_0027157850__b113917801813">iptables -t nat -D POSTROUTING -o eth0 -s</strong> <em id="EN-US_TOPIC_0027157850__i8372144335512">subnet/netmask-bits</em> <strong id="EN-US_TOPIC_0027157850__b1460282592619">-j SNAT --to</strong> <em id="EN-US_TOPIC_0027157850__i5374194312551">nat-instance-ip</em></p>
<p id="EN-US_TOPIC_0027157850__p8375243145518">For example, if the proxy <span id="EN-US_TOPIC_0027157850__text73801859163916">ECS</span> is in network segment 192.168.125.0, the subnet mask has 24 bits, and the private IP address is 192.168.125.4, run the following command:</p>
<p id="EN-US_TOPIC_0027157850__p1714191411552"><strong id="EN-US_TOPIC_0027157850__b17751115445510">iptables -t nat -D POSTROUTING -o eth0 -s 192.168.125.0/24 -j SNAT --to 192.168.125.4</strong></p>
</li></ol>
</div>
</div>
<div>
<div class="familylinks">
<div class="parentlink"><strong>Parent topic:</strong> <a href="en-us_topic_0140313883.html">EIPs</a></div>
</div>
</div>


<script language="JavaScript">
<!--
image_size('.imgResize');
var msg_imageMax = "view original image";
var msg_imageClose = "close";
//--></script>